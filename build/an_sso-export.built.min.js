"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};(function(){var N,D=[].indexOf;(N=function(){var p,t,l,u,o,h,n,_,r,f,i,s,a,c,g,y,m,w,v,k,b,I,x,S,C,j,O,R,T,A,U,E,J,z,M,W;return p=["fr","de","en","it","es"],c={base_is_host:"https://account.asmodee.net",base_is_path:"/main/v2/oauth",logout_endpoint:"/main/v2/logout",base_url:"https://api.asmodee.net/main/v1",client_id:null,redirect_uri:null,cancel_uri:null,logout_redirect_uri:null,callback_post_logout_redirect:null,base_uri_for_iframe:null,scope:"openid+profile",response_type:"id_token token",display:"popup",display_options:{},iframe_css:null,callback_signin_success:function(){return console.log(arguments)},callback_signin_error:function(){return console.error(arguments)}},J={},M=C=null,l=I=t=x=y=S=a=null,_=[],T="AsmodeeNetConnectWithOAuth",W="try_refresh",b={element:null,receiveMessageCallback:null,saveOptions:null},m=function(){var e,t,n,r,o;if(e=window.crypto||window.msCrypto,r=0,n=[],(r=e?e.getRandomValues(new Uint8Array(30)):[Math.random()]).constructor===Array)r.forEach(function(e){return n.push(e.toString(36))});else for(t in r)o=r[t],r.hasOwnProperty(t)&&n.push(o.toString(36));return(n.join("")+"00000000000000000").slice(2,18)},g=function(e){return null==e&&(e=!1),s(),l=I=t=x=a=null,e?(e(),"iframe"===J.display?N.signIn(b.saveOptions):void 0):window.location.reload()},j=function(e){return"popup"===J.display?R(e):"iframe"===J.display?O(e):window.location.assign(e.path)},k=function(e){return null==e.width&&(e.width=475),null==e.height&&(e.height=500),null==e.windowName&&(e.windowName=T),null==e.windowOptions&&(e.windowOptions="location=0,status=0,width="+e.width+",height="+e.height),null==e.callback&&(e.callback=function(){return window.location.reload()}),this._oauthWindow=window.open(e.path,e.windowName,e.windowOptions)},R=function(e){var t;return k(e),t=this,e.autoclose&&(t._oauthAutoCloseInterval=window.setInterval(function(){return t._oauthWindow.close(),delete t._oauthWindow,t._oauthAutoCloseInterval&&window.clearInterval(t._oauthAutoCloseInterval),t._oauthInterval&&window.clearInterval(t._oauthInterval),e.callback()},500)),t._oauthInterval=window.setInterval(function(){if(t._oauthWindow.closed)return t._oauthInterval&&window.clearInterval(t._oauthInterval),t._oauthAutoCloseInterval&&window.clearInterval(t._oauthAutoCloseInterval),e.callback()},1e3)},O=function(t){if(null==t.width&&(t.width=475),null==t.height&&(t.height=500),null==t.callback&&(t.callback=function(){return window.location.reload()}),b.element=-1!==J.iframe_css.indexOf("#")?window.document.getElementById(J.iframe_css.replace("#","")):window.document.getElementsByClassName(J.iframe_css)[0],b.element)return b.element.name=T,b.element.width=t.width,b.element.height=t.height,b.element.src=t.path,J.redirect_uri,b.element&&!b.element.closed&&b.element.focus(),b.receiveMessageCallback&&b.element.removeEventListener("load",b.receiveMessageCallback),b.receiveMessageCallback=function(e){if(e.currentTarget.name===T&&(e.currentTarget.contentWindow||e.currentTarget.contentDocument,w("gd_connect_hash")))return t.callback()},b.element.addEventListener("load",b.receiveMessageCallback,!1)},u=function(e){if(l=(t=e).access_token,I=t.id_token,t.code)return a=t.code},h=function(e,t){var n;for(n=(n=KJUR.crypto.Util.sha256(t)).substr(0,n.length/2);e.length%4!=0;)e+="=";return window.AsmodeeNet.verifyBHash(e),e===btoa(n)},f=function(e,t){var n,r,o,i,s,a,c,l;if(t.access_token)try{jwt_decode(t.access_token),jwt_decode(t.access_token,{header:!0})}catch(e){return o=e,_.push("access_token decode error : "+o),!1}if(0<=J.response_type.search("id_token")){if(void 0===_typeof(t.id_token))return!1;try{i=jwt_decode(t.id_token),s=jwt_decode(t.id_token,{header:!0})}catch(e){return o=e,_.push("id_token decode error : "+o),!1}if("JWT"!==s.typ)return _.push("Invalid type"),!1;if("RS256"!==s.alg)return _.push("Invalid alg"),!1;if(e&&i.nonce!==e)return _.push("Invalid nonce"),!1;if(URI(i.iss).normalize().toString()!==URI(J.base_is_host).normalize().toString())return _.push("Invalid issuer"),!1;if(i.aud!==J.client_id&&(!Array.isArray(i.aud)||-1===id_dec.aud.indexOf(J.client_id)))return _.push("Invalid auditor"),!1;if(i.exp<window.AsmodeeNet.limit_exp_time())return _.push("Invalid expiration date"),!1;if("string"==typeof i.at_hash&&!h(i.at_hash,t.access_token))return _.push("Invalid at_hash"),!1;if(t.code&&"string"==typeof i.c_hash&&!h(i.c_hash,t.code))return _.push("Invalid c_hash"),!1;for(n=[s.alg],a=0,l=S.length;a<l;a++)if((c=S[a]).alg&&c.alg===n[0])try{if(KJUR.jws.JWS.verify(t.id_token,KEYUTIL.getKey(c),n))return!0}catch(e){r=e,console.error("JWS verify error",r)}return _.push("Invalid JWS key"),!1}return!0},i=function(){var e;if(J.base_is_host&&(e=URI(J.base_is_host),J.base_is_host=e.protocol()+"://"+e.host()),J.base_url&&(J.base_url=URI(J.base_url).normalize().toString()),J.logout_redirect_uri)return J.logout_redirect_uri=URI(J.logout_redirect_uri).normalize().toString()},r=function(){var e;if(J.logout_redirect_uri&&new RegExp(J.logout_redirect_uri.replace(/([?.+*()])/g,"\\$1")).test(window.location.href)&&"iframe"!==J.display&&((e=window.location.href.replace(J.logout_redirect_uri+"&state=","").replace(/[&#].*$/,""))===w("logout_state")||!e&&!w("logout_state")))return A("logout_state"),J.callback_post_logout_redirect?J.callback_post_logout_redirect():window.location="/"},v=function(e){return document.createElement("a").href=e},o=function(e,t,n){var r,o,i,s,a,c,l,u;if(""!==(i=(n=n||{}).locale?"/"+n.locale:"")&&-1===p.indexOf(i)&&(i="en"),"iframe"===J.display&&(b.saveOptions=N.extend({},n)),M=m(),C=m(),E("state",M,"iframe"===J.display?1440:20),E("nonce",C,"iframe"===J.display?1440:20),J.callback_signin_success=n.success||J.callback_signin_success,J.callback_signin_error=n.error||J.callback_signin_error,l=v(t),s=t.replace(l.pathname,n.locale+l.pathname),n.path=s+"?display="+J.display+"&response_type="+encodeURI(J.response_type)+"&state="+M+"&client_id="+J.client_id+"&scope="+J.scope,J.redirect_uri&&(c=J.redirect_uri,n.redirect_extra&&(c+=n.redirect_extra),n.path+="&redirect_uri="+encodeURI(c)),0<=J.response_type.search("id_token")&&(n.path+="&nonce="+C),0<Object.keys(J.display_options).length)for(o in a=J.display_options)u=a[o],n.path+="&display_opts["+o+"]="+(u?"1":"0");return J.cancel_uri&&(n.path+="&cancel_uri="+encodeURI(J.cancel_uri)),r=e,n.callback=function(){return A(W),z(r)},j(n)},z=function(e){var t,n,r,o,i,s,a,c;if(n=w("gd_connect_hash")){if(A("gd_connect_hash"),t={},a=null,0===n.search(/^#/)){for(r=0,o=(a=n.replace(/^#/,"").split("&")).length;r<o;r++)t[(c=(c=a[r]).split("="))[0]]=c[1];if(t.token_type&&"bearer"===t.token_type&&(M=w("state"),C=w("nonce"),t.state))return t.state===M?(t.scope=t.scope.split("+"),t.expires=jwt_decode(t.access_token).exp,_=[],f(C,t)?(A("state"),A("nonce"),u(t),e.identity({success:J.callback_signin_success,error:J.callback_signin_error})):J.callback_signin_error("Tokens validation issue : ",_)):J.callback_signin_error("Tokens validation issue : ","Invalid state")}else if(0===n.search(/^\?/)){for(s=0,i=(a=n.replace(/^\?/,"").split("&")).length;s<i;s++)t[(c=(c=a[s]).split("="))[0]]=c[1];if(M=w("state"),A("state"),t.state&&t.state===M)return J.callback_signin_error(parseInt(t.status),t.error,t.error_description.replace(/\+/g," "))}}else if("popup"===J.display)return J.callback_signin_error("popup closed without signin")},n=function(){var e,t,n,r;if(r=null,"touch"===(t=J.display)||"iframe"===t?r={noheader:!0,nofooter:!0,lnk2bt:!0,leglnk:!1,cookies:!0}:"popup"===J.display&&(r={noheader:!1,nofooter:!1,lnk2bt:!1,leglnk:!0}),0<Object.keys(J.display_options).length&&r)for(e in n=J.display_options)n[e],D.call(Object.keys(r),e)<0&&delete J.display_options[e];if(J.display_options=N.extend(r,J.display_options),0<=D.call(Object.keys(J.display_options),"cookies")&&!0===J.display_options.cookies&&delete J.display_options.cookies,"touch"===J.display&&!J.cancel_uri)return J.cancel_uri=J.redirect_uri},U=function(e,t,n){var r,o;return o=n?((r=new Date).setTime(r.getTime()+1e3*n),"; expires="+r.toGMTString()):"",document.cookie=e+"="+t+o+"; path=/"},function(e){var t,n,r,o;for(o=e+"=",n=document.cookie.split(";"),r=0;r<n.length;){for(t=n[r];" "===t.charAt(0);)t=t.substring(1,t.length);if(0===t.indexOf(o))return t.substring(o.length,t.length);r++}return null},function(e){return U(e,"",-1)},function(){var e,t,n,r,o,i,s;for(s=[],r=0,o=(n=document.cookie.split("; ")).length;r<o;r++)e=n[r],t=encodeURIComponent(e.split(";")[0].split("=")[0])+"=; expires=Thu, 01-Jan-1970 00:00:01 GMT; domain="+d.join(".")+" ;path=",i=location.pathname.split("/"),s.push(function(){var e;for(e=[];0<i.length;)document.cookie=t+i.join("/"),e.push(i.pop());return e}());return s},E=function(t,n,e){var r;try{return store.set(t,n,(new Date).getTime()+6e4*e)}catch(e){return r=e,console.error("SetItem '"+t+"'",n,r)}},w=function(t){var n;try{return store.get(t)}catch(e){return n=e,console.error("GetItem '"+t+"'",n),null}},A=function(e){return store.remove(e)},s=function(){return store.clearAll()},{verifyBHash:function(e){return e},init:function(e){return J=this.extend(c,e),i(),n(),r(),this},baseSettings:function(){return{crossDomain:!0,dataType:"json",headers:{Authorization:"Bearer "+l,Accept:"application/json"}}},isConnected:function(){return null!==this.getAccessToken()},getAccessToken:function(){return l},getIdToken:function(){return I},getAccessHash:function(){return t},getDiscovery:function(){return y},getCode:function(){return a},getCheckErrors:function(){return _},isJwksDone:function(){return null!==S},getConfiguredScope:function(){return J.scope},getConfiguredAPI:function(){return J.base_url},getClientId:function(){return J.client_id},getSettings:function(){return this.extend({},J)},getIdentity:function(){return x},getScopes:function(){return this.isConnected()?this.getAccessHash().scope:null},getExpires:function(){return this.isConnected()?this.getAccessHash().expires:null},getExpiresDate:function(){return this.isConnected()?new Date(1e3*this.getAccessHash().expires):null},auth_endpoint:function(){return y?URI(y.authorization_endpoint).normalize().toString():URI(J.base_is_host+J.base_is_path+"/authorize").normalize().toString()},ident_endpoint:function(){return y?URI(y.userinfo_endpoint).normalize().toString():URI(J.base_is_host+J.base_is_path+"/identity").normalize().toString()},ajaxq:function(e,t,n){var r,o;return null==n&&(n={}),r=n.base_url||J.base_url||c.base_url,delete n.base_url,o=this.extend(n,this.baseSettings(),{type:e}),void 0!==n.auth&&!1===n.auth&&(o.headers.Authorization&&delete o.headers.Authorization,delete o.auth),this.ajax(r+t,o)},get:function(e,t){return this.ajaxq("GET",e,t)},post:function(e,t){return this.ajaxq("POST",e,t)},update:function(e,t){return this.ajaxq("PUT",e,t)},delete:function(e,t){return this.ajaxq("DELETE",e,t)},discover:function(e){var t;return e=e||J.base_is_host||c.base_is_host,e=(e=URI(e)).protocol()+"://"+e.host(),(t=this).get("/.well-known/openid-configuration",{base_url:e,auth:!1,success:function(e){return y="object"===(void 0===e?"undefined":_typeof(e))?e:JSON.parse(e),J.base_is_host=URI(y.issuer).normalize().toString(),J.logout_endpoint=URI(y.end_session_endpoint).normalize().toString(),t.getJwks()},error:function(){return console.error("error Discovery on "+e,arguments)}})},getJwks:function(){var t;return(t=this).get("",{base_url:URI(y.jwks_uri).normalize().toString(),auth:!1,success:function(e){if(S="object"===(void 0===e?"undefined":_typeof(e))?e.keys:JSON.parse(e).keys,"popup"!==J.display)return z(t)},error:function(){if(console.error("error JWKS",arguments),0<arguments.length&&console.error("error JWKS => "+arguments[0]),0<arguments.length)return console.error("error JWKS => "+arguments[0].statusText)}})},signUp:function(e,t,n,r){return-1===p.indexOf(e)&&(e="en"),n||(n=y.issuer),r||(r="/signup"),o(this,URI(n).normalize().toString()+e+r,t)},resetPass:function(e,t,n,r){return-1===p.indexOf(e)&&(e="en"),n||(n=y.issuer),r||(r="/reset"),o(this,URI(y.issuer).normalize().toString()+e+r,t)},signIn:function(e,t,n){return t=t?URI(t).normalize().toString()+locale+n:this.auth_endpoint(),o(this,t,e)},identity:function(o){return this.isConnected()?this.isConnected()&&x?("iframe"===J.display&&(b.element.src=""),o&&o.success?o.success(x,N.getCode()):void 0):this.get("",{base_url:this.ident_endpoint(),success:function(e){if(x=e,"iframe"===J.display&&(b.element.src=""),o&&o.success)return o.success(x,N.getCode())},error:function(e,t,n,r){return o&&o.error?o.error(e,t,n,r):console.error("identity error",e,t,n,r)}}):(o&&o.error?o.error("Identity error. Not connected",null,null,"Not Connected"):console.error("identity error","You're not connected"),!1)},restoreTokens:function(e,t){var n,r,o,i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],s=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null,c=5<arguments.length&&void 0!==arguments[5]?arguments[5]:null;if(e&&l&&(e=null),t&&I&&(I=null),e)if(o={access_token:e,id_token:t},this.isJwksDone())if(f(null,o)){if(r=jwt_decode(e),o.scope=r.scope.split(" "),o.expires=r.exp,o.token_type=r.token_type,A(W),u(o),i&&this.identity({success:J.callback_signin_success,error:J.callback_signin_error}),c&&(x=c),!s)return!0;s(!0)}else if(n=w(W),A(W),"Invalid expiration date"===_[0]&&a&&!n)console.log("try refresh token"),E(W,!0),a()&&N.signIn({success:s});else{if(!s)return!1;s(!1,_)}else setTimeout(function(){return N.restoreTokens(e,t,i,s,a,c)},200);return null},setAccessToken:function(e){return l=e},setIdToken:function(e){return I=e},signOut:function(e){var t,n,r;if(r=e&&void 0!==e.success?e.success:null,this.isConnected()||e.force){if(!J.logout_redirect_uri)return g(r);if(M=m(),t=I,E("logout_state",M,5),n=J.logout_endpoint+"?post_logout_redirect_uri="+encodeURI(J.logout_redirect_uri)+"&state="+M+"&id_token_hint="+t,"iframe"!==J.display)return"popup"===J.display?(e.path=n,e.callback=function(){return g(r)},R(e)):window.location=n;if(b.element)return b.element.src=n,J.logout_redirect_uri,b.receiveMessageCallback&&b.element.removeEventListener("load",b.receiveMessageCallback),b.receiveMessageCallback=function(e){if(e.currentTarget.name===T)return g(r)},b.element.addEventListener("load",b.receiveMessageCallback,!1)}},trackCb:function(e){if(null==e&&(e=!0),""!==window.location.hash?E("gd_connect_hash",window.location.hash,5):""!==window.location.search&&E("gd_connect_hash",window.location.search,5),"AsmodeeNetConnectWithOAuth"===window.name&&(console.log("ok try closeit"),e))return window.close()},inIframe:function(){return window.self===window.top}}}).ajax=function(e,r){var t,o,n,i,s,a,c,l,u,d;for(a in r=1===(t=arguments).length?t[0]:t[1],i=function(){return null},n={url:2===t.length&&"string"==typeof e?e:".",cache:!0,data:{},headers:{},context:null,type:"GET",success:i,error:i,complete:i},r=this.extend(n,r||{}),c={"application/json":"json","text/html":"html","text/plain":"text"},r.cache||(r.url=r.url+(r.url.indexOf("?")?"&":"?")+"noCache="+Math.floor(9e9*Math.random())),u=function(e,t,n){var r;return r="success",n.success.call(n.context,e,r,t),o(r,t,n)},s=function(e,t,n,r){return r.error.call(r.context,n,t,e),o(t,n,r)},o=function(e,t,n){return n.complete.call(n.context,t,e)},l=function(){var e,t,n;if(4===d.readyState){if(n=null,t=d.getResponseHeader("content-type"),e=c[t]||"text",200<=d.status&&d.status<300||304===d.status){n=d.responseText;try{"json"===e&&(n=JSON.parse(n))}catch(e){return void s(e.message,"parsererror",d,r)}return void u(n,d,r)}n=d.responseText;try{return"json"===e&&(n=JSON.parse(n)),void s(n,"error",d,r)}catch(e){return void s(e.message,"parsererror",d,r)}return s(n,"error",d,r)}},(d=new XMLHttpRequest).addEventListener?d.addEventListener("readystatechange",l,!1):d.attachEvent&&d.attachEvent("onreadystatechange",l),d.open(r.type,r.url),"POST"===r.type&&(r.headers=this.extend({"Content-type":"application/x-www-form-urlencoded"},r.headers,{"X-Requested-With":"XMLHttpRequest"})),r.headers)d.setRequestHeader(a,r.headers[a]);return d.send(r.data),this},N.extend=function(){var e,t,n,r,o;for(o={},e=0,n=arguments.length;e<n;e++)for(t in r=arguments[e])Object.prototype.hasOwnProperty.call(r,t)&&(o[t]=r[t]);return o},N.limit_exp_time=function(){return(Date.now()/1e3).toPrecision(10)},N.jwt_decode=function(e,t){var n;return n=KJUR.jws.JWS.parse(e),t&&"undefined"!==t.header&&!0===t.header?n.headerObj:n.payloadObj},module.exports({AsmodeeNet:N})}).call(void 0);
//# sourceMappingURL=an_sso-export.built.min.js.map