<html>
    <head>
        <script>document.write('<script src="an_sso.min.js?dev=' + Math.floor(Math.random() * 100) + '"\><\/script>');</script>
    </head>
    <body>
        <script>AsmodeeNet.trackCb(false);</script>
        <button id="connect_bt">Sign In</button>
        <div id="profile" style="display:none;">
            <button id="disconnect_bt">Sign Out</button> -
            <button id="my_identity">My identity</button>
        </div>
        <br/>
        <div id="output">

        </div>
        <div id="connectedbyvue" style="display:none;"><div id="buddies-target"></div></div>
        <script>
        function echo() {
            var output = '';
            for(var i = 0; i < arguments.length; i++) {
                output += JSON.stringify(arguments[i], null, "\t") + "\n";
            }
            findMe('output').innerHTML = '<pre>'+output+'</pre>';
        }
        function findMe(id) {
            return document.getElementById(id);
        }

        function signed(identity) {
            echo(identity, AsmodeeNet.getAccessHash());
            // console.log(jwt_decode(AsmodeeNet.getAccessToken()));
            findMe('connect_bt').style.display = 'none';
            findMe('profile').style.display = 'block';
            var tok = jwt_decode(AsmodeeNet.getAccessToken());
            findMe('connectedbyvue').style.display = 'block';
            if (typeof asnetbus != undefined) {
               asnetbus.push('user-connected', {
                   url: 'http://localhost:8008/main',
                   token: AsmodeeNet.getAccessToken(),
                   userId: tok.sub,
                   expires: tok.exp,
                   scopes: AsmodeeNet.getScopes()
               });
            }
        }
        function unsigned() {
            findMe('profile').style.display = 'none';
            findMe('connect_bt').style.display = 'block';
            echo("You're logged out");
        }
        findMe('connect_bt').addEventListener('click', function() {
            AsmodeeNet.signIn({
                // width: 475,
                // height: 500,
                success: signed,
                error: function() {
                    echo("SIGNIN ERROR", arguments);
                }
            });
        });
        findMe('disconnect_bt').addEventListener('click', function() {
            AsmodeeNet.signOut({
                success: unsigned // this callback will be never used in page/touch mode
            });
        });
        findMe('my_identity').addEventListener('click', function() {
            AsmodeeNet.identity({
                success: function(data) {
                    echo("My Identity", arguments);
                }
            });
        });

        function asnetapiOnLoad() {
            if (typeof asnetbus != undefined){asnetbus.init({env: 'development', lang: 'fr'});}
        }
        document.addEventListener('vue-init', function () {
            console.log('vue init');
            asnet_wc('#buddies-target', {
                module: 'buddies-activities',
                title: "L'activité de mes amis",
                trans: {
                    last_used: "Dernière utilisation",
                    nobody: "Aucun de vos amis n'a encore joué à l'un de nos jeux."
                },
                width: 430
            });
        });
        </script>
        <script type="text/javascript" src="//localhost:8009/js/dist/front/asnetapi.manifest.js"></script>
        <script type="text/javascript" src="//localhost:8009/js/dist/front/asnetapi.vendor.js"></script>
        <script type="text/javascript" src="//localhost:8009/js/dist/front/asnetapi.main.js" onload="asnetapiOnLoad()"></script>
        <script>
        AsmodeeNet.init({
            // Required parameters
            client_id: 'test_direct', //'openid-ffg', //'test_direct', //'openid-dow', 'asmoclub', //
            redirect_uri: 'http://localhost:8080/?cok=1', // 'https://login.salesforce.com/services/authcallback/00D2000000099GxEAI/asmoclub', // 'https://community-dev.fantasyflightgames.com/oauth/callback',
            cancel_uri: 'http://localhost:8080/?cancel=1', // only used by the touch mode on IS
            // Example of optional parameters
            base_is_host: 'http://localhost:8009/', // 'https://account.asmodee.net'
            scope: 'openid profile email address public private',
            response_type: 'code id_token token',
            display: 'page', // display type: 'page' 'touch' 'popup' 'iframe' (page by default)

            display_options: {
                // noheader: true,
                // lnk2bt: true,
                // nofooter: true,
                // leglnk: false
            },
            logout_redirect_uri: 'http://localhost:8080/?logout_redirect=1',
            // if next callback for RP logout openid's feature is not provided, the AsmodeeNet SSO lib, redirect the user to the root ('/') of the current host
            callback_post_logout_redirect: function() {
                alert('Disconnected');
                window.location = '/';
            },
            callback_signin_success: signed,
            callback_signin_error: function() {
                echo("SIGNIN ERROR", arguments);
            }
        }).discover();
        </script>
        <style>
        .asnet_comp_root {
            position: fixed;
            right: 10px;
            top: 10px;
        }
        .asnet_comp_root .buddies-activity {
            background-color: white;
        }


        </style>
    </body>
</html>
